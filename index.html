<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>Title Goes Here</title>
    <script type="text/javascript" src="p5.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="svg.js"></script>
    <script type="text/javascript" src="twgl-full.js"></script>
    <script type="text/javascript" src="lodash.js"></script>
    <script type="text/javascript" src="boids.js"></script>
</head>

<body>
    <svg id="eyebeam" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
        x="0px" y="0px" viewbox="0 0 1920 1440" style="enable-background:new 0 0 1920 1440; display: none;" xml:space="preserve">
        <rect width="100%" height="100%"></rect>
        <g xmlns="http://www.w3.org/2000/svg">
            <polygon
                points="37.13,218.68 218.97,218.68 218.97,182.31 73.5,182.31 73.5,145.94 218.97,145.94 218.97,109.57 73.5,109.57    73.5,73.2 218.97,73.2 218.97,36.84 37.13,36.84  " />
            <polygon
                points="417.58,36.84 372.72,36.84 326.66,105.93 280.6,36.84 235.74,36.84 306.6,143.12 306.6,218.68 346.72,218.68    346.72,143.12  " />
            <polygon
                points="771.67,36.84 771.67,73.2 467.89,73.2 467.89,109.57 771.67,109.57 771.67,145.94 467.89,145.94 467.89,182.31    771.67,182.31 771.67,218.68 431.52,218.68 431.52,36.84  " />
            <path
                d="M791.76,218.68h284.15v0c30.13,0,54.55-24.42,54.55-54.55c0-16.31-7.17-30.94-18.52-40.94   c6.44-8.95,10.24-19.93,10.24-31.8c0-29.61-23.59-53.69-52.99-54.51v-0.04H791.76V218.68z M1067.64,73.2   c10.04,0,18.18,8.14,18.18,18.18s-8.14,18.18-18.18,18.18H828.13V73.2H1067.64z M828.13,182.31v-36.37h247.78v0   c10.04,0,18.18,8.14,18.18,18.18c0,10.04-8.14,18.18-18.18,18.18H828.13z" />
            <polygon
                points="1494.05,218.68 1494.05,182.31 1182.69,182.31 1182.69,145.94 1494.05,145.94 1494.05,109.57 1182.69,109.57    1182.69,73.2 1494.05,73.2 1494.05,36.84 1146.32,36.84 1146.32,218.68  " />
            <path
                d="M1651.53,218.68h39.2l-72.74-181.84h-36.37l-72.74,181.84h39.2l14.55-36.37h74.35L1651.53,218.68z M1577.18,145.94   l22.63-56.57l22.63,56.57H1577.18z" />
            <polygon
                points="1702.68,36.84 1702.68,218.68 1739.05,218.68 1739.05,73.2 1775.42,73.2 1775.42,218.68 1811.78,218.68    1811.78,73.2 1848.15,73.2 1848.15,218.68 1884.52,218.68 1884.52,36.84  " />
            <polygon
                points="1884.52,417.29 1884.52,372.43 1815.43,326.37 1884.52,280.3 1884.52,235.45 1778.23,306.3 1702.68,306.3    1702.68,346.43 1778.23,346.43  " />
            <polygon
                points="1884.52,613.07 1848.15,613.07 1848.15,467.59 1811.78,467.59 1811.78,613.07 1775.42,613.07 1775.42,467.59    1739.05,467.59 1739.05,613.07 1702.68,613.07 1702.68,431.23 1884.52,431.23  " />
            <path
                d="M1702.68,633.16v127.29h0c0,30.13,24.42,54.55,54.55,54.55c16.31,0,30.94-7.17,40.94-18.52   c8.95,6.44,19.93,10.24,31.8,10.24c29.61,0,53.69-23.59,54.51-52.99h0.04V633.16H1702.68z M1848.15,752.17   c0,10.04-8.14,18.18-18.18,18.18c-10.04,0-18.18-8.14-18.18-18.18v-82.64h36.37V752.17z M1739.05,669.53h36.37v90.92h0   c0,10.04-8.14,18.18-18.18,18.18s-18.18-8.14-18.18-18.18V669.53z" />
            <polygon xmlns="http://www.w3.org/2000/svg"
                points="1702.68,1012.69 1739.05,1012.69 1739.05,867.22 1775.42,867.22 1775.42,1012.69 1811.78,1012.69 1811.78,867.22    1848.15,867.22 1848.15,1012.69 1884.52,1012.69 1884.52,830.85 1702.68,830.85  " />
            <path
                d="M1702.68,1170.17v39.2l181.84-72.74v-36.37l-181.84-72.74v39.2l36.37,14.55v74.35L1702.68,1170.17z M1775.42,1095.82   l56.57,22.63l-56.57,22.63V1095.82z" />
            <polygon
                points="1884.52,1221.32 1884.52,1403.16 1702.68,1403.16 1702.68,1366.8 1848.15,1366.8 1848.15,1330.43 1702.68,1330.43    1702.68,1294.06 1848.15,1294.06 1848.15,1257.69 1702.68,1257.69 1702.68,1221.32  " />
            <polygon
                points="1504.07,1403.16 1548.93,1403.16 1594.99,1334.07 1641.05,1403.16 1685.91,1403.16 1615.05,1296.88    1615.05,1221.32 1574.93,1221.32 1574.93,1296.88  " />
            <polygon
                points="1149.98,1403.16 1149.98,1366.8 1453.76,1366.8 1453.76,1330.43 1149.98,1330.43 1149.98,1294.06 1453.76,1294.06    1453.76,1257.69 1149.98,1257.69 1149.98,1221.32 1490.13,1221.32 1490.13,1403.16  " />
            <path
                d="M1129.88,1221.32H845.73l0,0c-30.13,0-54.55,24.42-54.55,54.55c0,16.31,7.17,30.94,18.52,40.94   c-6.44,8.95-10.24,19.93-10.24,31.8c0,29.61,23.59,53.69,52.99,54.51v0.04h277.43V1221.32z M854.01,1366.8   c-10.04,0-18.18-8.14-18.18-18.18c0-10.04,8.14-18.18,18.18-18.18h239.51v36.37H854.01z M1093.52,1257.69v36.37H845.73v0   c-10.04,0-18.18-8.14-18.18-18.18s8.14-18.18,18.18-18.18H1093.52z" />
            <polygon
                points="427.6,1221.32 427.6,1257.69 738.96,1257.69 738.96,1294.06 427.6,1294.06 427.6,1330.43 738.96,1330.43    738.96,1366.8 427.6,1366.8 427.6,1403.16 775.33,1403.16 775.33,1221.32  " />
            <path
                d="M270.12,1221.32h-39.2l72.74,181.84h36.37l72.74-181.84h-39.2l-14.55,36.37h-74.35L270.12,1221.32z M344.47,1294.06   l-22.63,56.57l-22.63-56.57H344.47z" />
            <polygon
                points="218.97,1403.16 218.97,1221.32 182.6,1221.32 182.6,1366.8 146.23,1366.8 146.23,1221.32 109.87,1221.32    109.87,1366.8 73.5,1366.8 73.5,1221.32 37.13,1221.32 37.13,1403.16  " />
            <polygon
                points="37.13,1022.71 37.13,1067.57 106.22,1113.63 37.13,1159.7 37.13,1204.55 143.42,1133.7 218.97,1133.7    218.97,1093.57 143.42,1093.57  " />
            <polygon
                points="37.13,826.93 73.5,826.93 73.5,972.41 109.87,972.41 109.87,826.93 146.23,826.93 146.23,972.41 182.6,972.41    182.6,826.93 218.97,826.93 218.97,1008.77 37.13,1008.77  " />
            <path
                d="M218.97,806.84V679.55h0c0-30.13-24.42-54.55-54.55-54.55c-16.31,0-30.94,7.17-40.94,18.52   c-8.95-6.44-19.93-10.24-31.8-10.24c-29.61,0-53.69,23.59-54.51,52.99h-0.04v120.57H218.97z M73.5,687.83   c0-10.04,8.14-18.18,18.18-18.18s18.18,8.14,18.18,18.18v82.64H73.5V687.83z M182.6,770.47h-36.37v-90.92h0   c0-10.04,8.14-18.18,18.18-18.18c10.04,0,18.18,8.14,18.18,18.18V770.47z" />
            <polygon
                points="218.97,427.31 182.6,427.31 182.6,572.78 146.23,572.78 146.23,427.31 109.87,427.31 109.87,572.78 73.5,572.78    73.5,427.31 37.13,427.31 37.13,609.15 218.97,609.15  " />
            <path
                d="M218.97,269.83v-39.2L37.13,303.37v36.37l181.84,72.74v-39.2l-36.37-14.55v-74.35L218.97,269.83z M146.23,344.18   l-56.57-22.63l56.57-22.63V344.18z" />
        </g>
    </svg>
    <canvas id="glCanvas" width="1200" height="900"></canvas>
</body>
<script id="vs" type="notjs">
#version 300 es
in vec4 position;

void main() {
gl_Position = position;
}
</script>
<script id="fs" type="notjs">
#version 300 es
precision mediump float;

uniform vec2 resolution;
uniform float time;
uniform sampler2D svgFrame;

out vec4 fragColor;
void main() {
vec2 uv = gl_FragCoord.xy / resolution;
float color = 0.0;
// lifted from glslsandbox.com
color += sin( uv.x * cos( time / 3.0 ) * 60.0 ) + cos( uv.y * cos( time / 2.80 ) * 10.0 );
color += sin( uv.y * sin( time / 2.0 ) * 40.0 ) + cos( uv.x * sin( time / 1.70 ) * 40.0 );
color += sin( uv.x * sin( time / 1.0 ) * 10.0 ) + sin( uv.y * sin( time / 3.50 ) * 80.0 );
color *= sin( time / 10.0 ) * 0.5;

vec4 col = vec4( vec3( color * 0.5, sin( color + time / 2.5 ) * 0.75, color ), 1.0 );
col = texture(svgFrame, uv);

fragColor = col;
}
</script>
<script src="svgAndP5transforms.js"></script>
<script type="text/javascript">
    //make SVG manipulatable via SVG.js library
    var svgDoc = SVG.adopt($("#eyebeam")[0]);

    //making copies of the initial positions/orientations of the SVG letters
    var letters = svgDoc.children()[1].children();
    var baseArrays = letters.map(elem => elem.array());
    var basePositions = letters.map(letter => ({ x: letter.x(), y: letter.y() }));
    letters.forEach((letter, i) => letter.type == "path" ? replaceVH(i, baseArrays, letters) : null);
    baseArrays = letters.map(elem => elem.array());
    var matricies = letters.map(elem => elem.matrixify());
    var spin = () => letters.map((p, i) => setTimeout(() => p.animate(500 * 2, "=").rotate(360 * 2), i * 100));

    var swapInfo = randomSwaps(baseArrays, 100);

    //creating img and canvas elements used to import the SVG into a WebGL texture
    const svgImg = new Image();
    const svgCanvas = document.createElement("canvas");
    svgCanvas.width = 1920;
    svgCanvas.height = 1440;
    svgCanvas.id = "svgCanvas"
    const svgContext = svgCanvas.getContext("2d");

    //rendering the SVG to a canvas element
    function renderSVGtoCanvas() {
        var svg = document.querySelector('svg');

        // get svg data
        var xml = new XMLSerializer().serializeToString(svg);

        // make it base64
        var svg64 = btoa(xml);
        var b64Start = 'data:image/svg+xml;base64,';

        // prepend a "header"
        var image64 = b64Start + svg64;

        // set it as the source of the img element
        svgImg.src = image64;

        // draw the image onto the canvas
        svgImg.onload = () => svgContext.drawImage(svgImg, 0, 0);
    }



    var flock;
    var width = 1920, height = 1440;

    //empty p5 setup function
    function setup() {
        var width = 1920, height = 1440;
        flock = new Flock();
        // Add an initial set of boids into the system
        for (let i = 0; i < 10; i++) {
            var svgCreator = r => svgDoc.circle(r).center(width/2, height/2).fill("rgb("+i*5+",50,50)");
            let b = new Boid(width/2, height/2, svgCreator, width, height, 220, 200);
            flock.addBoid(b);
        }
    }

    //playing with SVG colors
    svgDoc.children()[0].fill("black");
    letters.map(letter => letter.fill("white"));

    var refTime = 0;
    var time = Date.now() /1000;
    var speedScale = (time) => 1;

    //p5 draw loop to do the animation. Am only using p5 as a quick way to get a draw loop - this could be 
    //replaced to just use requestAnimationFrame() later
    frameCount = 0;
    function draw() {
        var width = 1920, height = 1440;

        var refTime = Date.now()/1000;
        var increment = Date.now()/1000 - time;
        time += increment * speedScale(refTime);

        var transformFunc = xy => normExec(xy, xyN => {
            var warp = coordWarp(xyN, time / 4, .5, 20);
            var cent = { x: .5, y: .5 };
            var diag = .5;
            // warp = mix(cent, warp, (1-(diag-distance(warp, cent))/diag)**2);
            warp = mix(xyN, warp, sinN(time + xyN.x * PI * 10.5)*3*sinN(time+xyN.x*PI));
            return warp;
        }, 1920, 1440);
        var foldRes = 50;// + 50 * sinN(time/10);
        var t2 = time / 10;
        // transformFunc = xy => ({x: xy.x*.7 + sinN(t2+xy.x/width*PI*foldRes)*0.3*width*sinN(time/1.2), 
        //                         y: xy.y*.7 + cosN(t2+xy.y/height*PI*foldRes)*0.3*height*sinN(time/1.4)});
        // transformFunc = a => ({x:a.x * sinN(time), y: a.y * sinN(time)});

        // if(frameCount%3 == 0 && swapInfo.swaps.length > 0){
        //     var swapPoints = swapInfo.swaps.pop();
        //     shapeArraySwap(swapPoints[0], swapPoints[1], swapInfo.shapeArrays);
        // }

        letters.forEach(function (letter, i) {
            var m = matricies[i];
            var phase = i / letters.length * PI*2;// * (1 + 10 * sinN(time / 3.3));

            var mapFunction = letter.type == "path" ? pathCoordinateTransform : polygonCoordinateTransform;
            var shapeArray = mapFunction(baseArrays[i], transformFunc);
            // letter.plot(shapeArray);

            var frameBox = {x: 0, y: 0, width: width, height: height};
            var bbox = getBoundingBox(baseArrays[i]);
            var xy2 = transformFunc(bbox);
            // bbox.x = xy2.x;
            // bbox.y = xy2.y;
            letter.plot(putLetterInBox(shapeArray, bbox));

            // if(frameCount%3 == 0 && swapInfo.swaps.length >= 0){
            //     letter.plot(swapInfo.shapeArrays[i]);
            // }
            // letter.fill({ opacity: sinN(time*4 + phase) });
            
        });

        frameCount++

        //render the updated SVG to a canvas
        renderSVGtoCanvas();
        flock.run();
    }
</script>

<script src="glSetup.js"></script>

</html>